let express,http,io,uuidv1;_21c‍.w("express",[["default",["express"],function(v){express=v}]]);_21c‍.w("http",[["default",["http"],function(v){http=v}]]);_21c‍.w("socket.io",[["default",["io"],function(v){io=v}]]);_21c‍.w("uuid/v1",[["default",["uuidv1"],function(v){uuidv1=v}]]);// express for creating the server

// enable http communcation

// create and manage sockets




const app = express();
const httpServer = http.createServer(app);
const socketIo = io(httpServer);

let users = {};
let games = {};

app.get("/", (req, res) => {
  res.send("<h1>Hello im the socket sever, I'm runing happily</h1>");
});

socketIo.on("connection", socket => {
  console.log(`user have connected: ${socket.id}`);

  // update users array adding the new user
  users = { ...users, [socket.id]: { name: "" } };

  // broadcast users to all clients
  socketIo.emit("user_update", users);

  // broadcast games to current users
  socketIo.emit("game_update", games);

  socket.on("disconnect", function() {
    console.log(`user have disconnected: ${socket.id}`);

    // removing the user that is disconnecting
    delete users[socket.id];

    // romoving game from the user that is disconnecting
    Object.keys(games).map(key => {
      if (games[key].creator === socket.id) {
        delete games[key];
      }
    })

    // broadcast games to current users
    socketIo.emit("game_update", games);

    // broadcast users to all clients
    socketIo.emit("user_update", users);
  });

  socket.on("name_update", user_name => {
    // update user name
    users = {
      ...users,
      [socket.id]: {
        ...users[socket.id],
        name: user_name
      }
    };

    // broadcast users to all clients
    socketIo.emit("user_update", users);
  });

  socket.on("create_game", () => {
    let gameAlreadyExist = false;
    Object.keys(games).map(key => {
      if (games[key].creator === socket.id) {
        gameAlreadyExist = true;
      }
    });
    if (!gameAlreadyExist) {
      games = {
        ...games,
        [uuidv1()]: {
          creator: socket.id,
          playerOne: socket.id,
          playerTwo: '',
          gameStatus: {
            status: "waiting on player two"
          }
        }
      };
      // broadcast games to current users
      socketIo.emit("game_update", games);
    }
  });

  socket.on('delete_game_by_user', data => {
    delete games[gameKey];
    // broadcast games to current users
    socketIo.emit("game_update", games);
  })

});

const PORT = 8000;
httpServer.listen(PORT, () => {
  console.log(`listening on port ${PORT}`);
});
